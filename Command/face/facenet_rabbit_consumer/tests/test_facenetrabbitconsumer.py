import os
from unittest import TestCase

import numpy as np
from sqlalchemy_utils import database_exists, drop_database
from milvus import Milvus, MetricType, IndexType
from milvus.client.exceptions import NotConnectError

from apollo import S3FileStore, PostgresDatabase
from apollo.models import DetectedFace
from .. import facenetrabbitconsumer
from face.facenet_analytic import facenetanalytic


class TestFacenetRabbitConsumer(TestCase):  

    @classmethod
    def setUpClass(self):
        self.s3_filestore = S3FileStore(url='http://localstack:4572', bucket_name="apollo-source-data")
        self.s3_filestore.wait_until_available()

        self.s3_filestore.upload_file("face/facenet_analytic/tests/test_files/clf.pkl", "local/facenet/model/clf.pkl")
        self.s3_filestore.upload_file("face/facenet_analytic/tests/test_files/kanye.png", "inputs/kanye.png")

    def setUp(self):
        face_analytic = facenetanalytic.FacenetAnalytic('facenet', self.s3_filestore)
        self.rabbit_consumer = facenetrabbitconsumer.FacenetRabbitConsumer('facenet', 'ApolloExchange', face_analytic, heartbeat=180)
        
        milvus_host = os.getenv('MILVUS_HOST', 'milvus-release')
        self.milvus = Milvus(host=milvus_host, port='19530')

    def tearDown(self):        
        user = os.getenv('POSTGRES_USER')
        password = os.getenv('POSTGRES_PASSWORD')
        host = os.getenv('POSTGRES_HOST')

        if database_exists(f"postgresql+psycopg2://{user}:{password}@{host}/apollo"):
            drop_database(f"postgresql+psycopg2://{user}:{password}@{host}/apollo")
        
        self.milvus.drop_collection(collection_name='facenet')

    @classmethod
    def tearDownClass(self):
        self.s3_filestore.delete_file("local/facenet/model/clf.pkl")
        self.s3_filestore.delete_file("inputs/kanye.png")
    
    def test_init(self):
        self.assertIsNotNone(self.rabbit_consumer.analytic)
        self.assertIsNotNone(self.rabbit_consumer.database)
        self.assertEqual('facenet', self.rabbit_consumer.analytic.name)

    def test_save_results_to_database(self):
        self.rabbit_consumer.save_results_to_database({"name": "s3://apollo-source-data/inputs/face/kanye.png", "description":"facenet"}, self.result_dataframe_dict)
        
        #check milvus
        status_has_collection, ok = self.milvus.has_collection("facenet")
        self.assertTrue(ok)
        status, stats = self.milvus.get_collection_stats("facenet")
        self.assertEqual(0, status.code)
        self.assertEqual(1, stats["row_count"])

        #check postgres
        session = self.rabbit_consumer.database.get_session()
        query_result = session.query(DetectedFace).filter_by(path = "s3://apollo-source-data/inputs/kanye.png").first()
        self.assertEqual(54, query_result.ulx)
        self.assertEqual(0, query_result.uly)
        self.assertEqual(138, query_result.lrx)
        self.assertEqual(94, query_result.lry)
        self.assertEqual('Unknown', query_result.prediction)
        session.close()

    def test_save_results_to_database_empty(self):
        self.rabbit_consumer.save_results_to_database({"name": "s3://apollo-source-data/inputs/kanye.png", "description":"facenet"}, {"dataframe": {}, "embedding_array":[]})
        status, ok = self.milvus.has_collection("facenet")
        
        #milvus collection was not created
        self.assertFalse(ok)

        #postgres entry not created
        session = self.rabbit_consumer.database.get_session()
        query_result = session.query(DetectedFace).all()
        self.assertEqual([], query_result)
        session.close()


    result_dataframe_dict = {
        'dataframe': {0: {'path': 's3://apollo-source-data/inputs/kanye.png', 'ulx': 54, 'uly': 0, 'lrx': 138, 'lry': 94, 'probability': 0.18580001519428482, 'prediction': 'Unknown'}}, 
        'embedding_array':  np.array([[ -9.31590272e-04,  1.34613765e-02, -2.70295329e-02,
                                        -5.51775098e-02,  3.90300825e-02,  7.11256266e-02,
                                        2.12122351e-02,  1.34597272e-02, -4.25037220e-02,
                                        -2.25947946e-02, -4.32537496e-03, -7.50317331e-03,
                                        -1.43097537e-02,  1.20338546e-02, -5.58307581e-03,
                                        5.82301170e-02, -5.78035191e-02,  5.36227487e-02,
                                        -6.58132583e-02,  2.50719618e-02,  4.23723646e-02,
                                        -7.58869527e-03,  9.02789086e-03,  6.76991343e-02,
                                        -3.53867374e-02,  3.21958289e-02, -1.14796665e-02,
                                        5.17669581e-02, -1.08720502e-02, -2.48628277e-02,
                                        9.10083950e-02,  9.59492177e-02, -6.88726734e-03,
                                        2.22881138e-02,  4.26747724e-02, -4.04338464e-02,
                                        3.94805660e-03,  6.89218938e-02,  2.63240878e-02,
                                        -2.23843362e-02,  5.51595688e-02, -2.31537968e-02,
                                        -2.56943591e-02,  2.37157382e-02, -7.18516782e-02,
                                        -5.08016422e-02,  2.28228606e-02,  2.06579771e-02,
                                        4.44082581e-02, -6.15673885e-02,  2.66383942e-02,
                                        -5.38298599e-02, -4.22583297e-02, -5.76772578e-02,
                                        5.94552346e-02,  3.04149874e-02,  9.06767603e-03,
                                        -4.64092307e-02, -2.28073839e-02, -1.05394073e-01,
                                        -4.48319577e-02,  4.69108000e-02,  4.70402613e-02,
                                        -6.04944210e-03,  8.51872042e-02,  7.82525353e-03,
                                        -1.38667896e-02,  3.54757048e-02,  2.77851243e-02,
                                        -2.62286775e-02,  5.68019636e-02,  9.98370163e-03,
                                        -1.07459925e-01, -8.26801360e-03, -2.96567697e-02,
                                        -4.49364781e-02, -2.00904664e-02,  8.25592801e-02,
                                        -6.53445199e-02, -2.85535417e-02, -9.35297087e-03,
                                        -6.42852578e-03, -4.17296700e-02, -7.62628799e-04,
                                        -4.72871289e-02,  6.32135570e-03,  6.93894401e-02,
                                        -1.71112586e-02, -6.27333997e-03, -2.24474147e-02,
                                        3.57289277e-02,  2.10321695e-02, -1.07230628e-02,
                                        -4.71934713e-02, -4.55787219e-03,  1.62530839e-02,
                                        5.80768697e-02, -1.31776836e-02, -1.21281631e-02,
                                        -5.95609546e-02, -4.04345468e-02,  1.67130418e-02,
                                        -9.86599773e-02,  1.21569475e-02,  3.60973440e-02,
                                        6.05645962e-02, -7.94613138e-02,  1.65315960e-02,
                                        -4.72777151e-02, -5.93605861e-02,  1.29459295e-02,
                                        -1.31519334e-02,  4.11120849e-03,  1.02248946e-02,
                                        -7.70010129e-02, -9.34407674e-03,  8.55686702e-03,
                                        7.18544179e-04,  6.72815517e-02, -2.31541805e-02,
                                        5.65067604e-02, -2.49191150e-02,  3.26403556e-03,
                                        1.39668202e-02,  5.77519685e-02, -1.12678548e-02,
                                        -4.01406027e-02, -5.03918789e-02,  1.05718558e-03,
                                        1.16933184e-02,  1.11595176e-01,  5.50033860e-02,
                                        1.93230733e-02, -8.40062723e-02, -5.52975796e-02,
                                        -2.59680487e-02, -6.96754903e-02, -1.73860267e-02,
                                        6.71131164e-02,  4.42331098e-02,  7.64177972e-03,
                                        -2.10665930e-02, -1.50228171e-02,  2.32866523e-03,
                                        -3.67017798e-02,  3.52983400e-02,  4.53659222e-02,
                                        -4.20809574e-02,  2.99543068e-02,  2.14256961e-02,
                                        -4.89416569e-02,  3.90845351e-02,  1.53868087e-02,
                                        4.53618020e-02, -3.78740989e-02, -4.67231460e-02,
                                        2.26272573e-03,  6.69140890e-02,  4.66224998e-02,
                                        3.09510762e-03,  4.07020329e-03,  4.18718010e-02,
                                        -1.14766695e-02, -3.42462352e-03,  1.03561357e-02,
                                        1.95683148e-02,  2.38113087e-02, -3.77858840e-02,
                                        4.45751324e-02, -3.98660824e-02,  6.83950866e-03,
                                        -3.51896212e-02,  2.24099290e-02,  6.72599906e-03,
                                        1.54978968e-02,  5.16429208e-02,  2.12109890e-02,
                                        1.94163881e-02, -1.30253201e-02,  4.89119403e-02,
                                        -2.11483743e-02,  4.00057435e-02,  2.91778408e-02,
                                        -7.80664990e-03,  9.03020725e-02,  8.72386545e-02,
                                        -5.96165732e-02, -3.60568374e-04, -4.02103253e-02,
                                        -2.09252853e-02, -4.55158912e-02, -9.12449211e-02,
                                        -7.68301561e-02,  5.41839376e-02, -1.61619373e-02,
                                        -1.18126245e-02, -3.34633067e-02, -5.64124770e-02,
                                        -3.10514029e-02,  1.18050911e-02,  4.06521559e-02,
                                        4.16814089e-02, -1.44933886e-03,  1.12399301e-02,
                                        1.92192534e-03, -2.71018203e-02, -3.76936458e-02,
                                        -2.11083181e-02,  1.33340340e-02, -3.94067131e-02,
                                        5.87283783e-02,  5.99200800e-02, -1.13593586e-01,
                                        -2.15489902e-02, -1.09339669e-01,  1.17109790e-02,
                                        7.82024115e-02, -1.60848126e-02, -5.38200513e-02,
                                        -8.78601708e-03,  5.12659661e-02, -4.19407971e-02,
                                        -5.37451580e-02,  2.75733764e-03, -2.33513564e-02,
                                        4.49738652e-03, -1.75544228e-02,  2.25368235e-02,
                                        3.93578857e-02, -1.03804894e-01, -2.86634210e-02,
                                        7.63623938e-02,  3.12697180e-02,  2.72573866e-02,
                                        5.94140925e-02, -3.71132046e-03,  4.06816741e-03,
                                        4.86792997e-03, -3.28331403e-02,  1.49609977e-02,
                                        4.49997298e-02,  8.91576186e-02,  1.40340058e-02,
                                        5.46308160e-02,  4.11474667e-02, -3.38361003e-02,
                                        -1.72381513e-02, -1.76404475e-03,  7.81183839e-02,
                                        -6.20111860e-02,  1.94862876e-02,  4.01815623e-02,
                                        -1.63419470e-02, -6.44596592e-02, -3.52545120e-02,
                                        1.37932468e-02,  3.66799161e-02,  2.49936488e-02,
                                        -1.62647180e-02, -6.34146631e-02,  2.79068877e-03,
                                        8.00051764e-02,  3.92437615e-02, -9.18617994e-02,
                                        1.29663432e-02,  7.43951416e-03, -6.56633154e-02,
                                        1.77529119e-02, -7.33458996e-02, -8.85837972e-02,
                                        -9.82852560e-03,  1.83154419e-02, -1.32419672e-02,
                                        2.46586208e-03,  2.80096033e-03,  2.98120510e-02,
                                        -5.11849597e-02, -1.76358260e-02,  5.49430959e-02,
                                        -8.86107907e-02, -3.06641906e-02, -3.65343429e-02,
                                        4.59130257e-02, -3.97467650e-02,  1.88294314e-02,
                                        1.35739082e-02, -1.86238308e-02,  4.20344882e-02,
                                        -1.89913418e-02,  4.32319082e-02,  8.61661043e-03,
                                        -4.47673444e-03,  1.74674299e-03,  3.86637226e-02,
                                        -1.12034544e-01,  1.78505555e-02,  6.33738339e-02,
                                        3.77547145e-02,  5.53905182e-02,  8.54023397e-02,
                                        -8.44444558e-02,  8.06515440e-02, -9.34588313e-02,
                                        1.09295491e-02,  6.02315217e-02, -6.40784055e-02,
                                        1.56213678e-02,  1.70329250e-02,  1.20361924e-01,
                                        -4.91852388e-02,  2.50148308e-03,  4.89994995e-02,
                                        -7.41130263e-02, -5.38936583e-03,  1.82177648e-02,
                                        9.54349898e-03, -1.10614039e-02,  1.29267722e-02,
                                        7.09472448e-02,  1.62543580e-02,  6.55567497e-02,
                                        5.50027788e-02, -1.45938518e-02,  4.06958349e-02,
                                        -5.76868504e-02, -4.16579954e-02,  1.86709668e-02,
                                        -3.28174494e-02,  7.31186569e-02,  4.83525358e-02,
                                        -5.44644035e-02, -8.49215910e-02, -6.87212944e-02,
                                        6.24813177e-02, -4.34818901e-02,  7.37368464e-02,
                                        1.98027268e-02, -7.66313961e-03, -2.50600204e-02,
                                        3.79358418e-02,  5.36958463e-02, -6.30309433e-02,
                                        -5.53614721e-02,  6.66223988e-02, -3.13386172e-02,
                                        -4.28184867e-02, -3.48743255e-04,  1.04532028e-02,
                                        2.81295311e-02,  3.67446132e-02, -3.40645085e-03,
                                        3.74331437e-02, -3.35158072e-02,  2.51543801e-02,
                                        -5.31687215e-03,  7.66270049e-03, -1.29483081e-02,
                                        -6.31966889e-02,  1.13004716e-02, -1.08271493e-02,
                                        -2.09470857e-02,  1.64356772e-02,  8.08852762e-02,
                                        1.10968634e-01, -5.92551269e-02, -3.94304506e-02,
                                        -1.84394699e-02,  4.40229736e-02, -4.91445092e-03,
                                        -9.74403881e-03,  9.14214738e-03,  9.88895819e-02,
                                        3.64258848e-02,  1.77461151e-02,  1.77221093e-02,
                                        9.68788192e-02,  7.12082312e-02, -1.45952549e-06,
                                        8.50632135e-03,  1.59275774e-02,  6.99323714e-02,
                                        -3.50799896e-02,  2.98376400e-02,  2.61590369e-02,
                                        2.33045183e-02,  6.66204244e-02, -3.12588997e-02,
                                        5.00777997e-02,  1.76425781e-02,  3.23627181e-02,
                                        -2.71756928e-02, -7.60940230e-03, -6.01317454e-03,
                                        -2.06753872e-02,  2.05772696e-03, -1.30439475e-02,
                                        1.28006563e-02, -1.31586436e-02, -1.90368004e-03,
                                        -4.14712094e-02,  3.52408215e-02,  2.64729410e-02,
                                        4.75535020e-02,  2.39946097e-02, -3.23343650e-02,
                                        -4.27307487e-02, -3.68603840e-02,  1.03175744e-01,
                                        4.01299112e-02, -6.81236212e-04,  5.49687296e-02,
                                        8.35652053e-02,  5.69866635e-02,  2.65219677e-02,
                                        3.36026214e-02,  4.34181541e-02,  2.25283541e-02,
                                        -4.24582586e-02, -1.45343514e-02,  5.69819212e-02,
                                        3.64658274e-02,  2.73649069e-03, -3.02868821e-02,
                                        5.05088829e-02, -2.23682281e-02, -5.65779731e-02,
                                        -4.89962138e-02, -3.74615714e-02, -1.90493825e-03,
                                        4.21767794e-02, -3.41248922e-02,  2.78472602e-02,
                                        7.20655546e-02,  3.36577371e-02, -1.89245008e-02,
                                        -1.35447076e-02,  2.89725065e-02,  1.23490095e-02,
                                        8.23925659e-02, -2.00123135e-02,  2.74849832e-02,
                                        -8.74979235e-03,  5.20982444e-02, -3.42076458e-02,
                                        -2.53505819e-02, -1.67128555e-02,  8.80692806e-03,
                                        -3.90728116e-02, -5.86548895e-02, -3.80069800e-02,
                                        -2.74445489e-02, -6.06155954e-02, -1.64811164e-02,
                                        2.50453427e-02,  2.25086492e-02, -1.52038014e-03,
                                        -4.80075777e-02,  5.21495864e-02, -5.02387024e-02,
                                        -3.87020782e-03,  5.65962233e-02,  4.56664935e-02,
                                        6.69778958e-02,  6.44550771e-02, -9.83256754e-03,
                                        -3.06857675e-02, -5.69445118e-02,  9.63336974e-03,
                                        -1.36795372e-03, -1.73008796e-02,  3.13524678e-02,
                                        -5.90773560e-02, -4.01208028e-02, -6.91203028e-02,
                                        9.98594426e-03,  2.49915477e-02, -1.05664410e-01,
                                        -5.70869679e-03,  2.66950950e-02, -2.67576966e-02,
                                        -5.76675832e-02,  6.61390647e-02, -6.13583997e-02,
                                        7.13078678e-02,  1.73068754e-02, -4.08988893e-02,
                                        -5.55290133e-02,  7.17117637e-03, -2.21251827e-02,
                                        3.08388583e-02, -3.88972163e-02, -4.88573760e-02,
                                        -2.84902751e-02,  6.63704053e-02, -3.72228064e-02,
                                        -3.48781124e-02,  2.64788121e-02, -1.08231576e-02,
                                        -4.70169969e-02, -9.83579457e-02, -1.11496840e-02,
                                        -2.23446451e-02, -9.69469398e-02,  2.57129711e-03,
                                        1.66965909e-02, -3.09518706e-02, -1.41987260e-02,
                                        -3.84335630e-02, -1.37189608e-02,  1.00666359e-02,
                                        -2.94497311e-02, -1.82714574e-02
                                    ]])
    }
